- name: Ensure GlusterFS brick directory exists
  ansible.builtin.file:
    path: /mnt/glusterfs-brick
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Detect filesystem type of /dev/sda
  ansible.builtin.command: lsblk -no FSTYPE /dev/sda
  register: sda_fstype
  changed_when: false

- name: Fail if /dev/sda is already formatted (unless allow_format=true)
  ansible.builtin.fail:
    msg: "/dev/sda already has a filesystem: {{ sda_fstype.stdout }} â€” refusing to format!"
  when:
    - sda_fstype.stdout != ""
    - not (allow_format | default(false))

- name: Create ext4 filesystem on /dev/sda if not present
  community.general.filesystem:
    fstype: ext4
    dev: /dev/sda
  when: not sda_fstype.stdout

- name: Get disk UUID
  ansible.builtin.command: blkid -s UUID -o value /dev/sda
  register: sda_uuid
  changed_when: false

- name: Mount GlusterFS brick via UUID
  ansible.posix.mount:
    path: /mnt/glusterfs-brick
    src: "UUID={{ sda_uuid.stdout }}"
    fstype: ext4
    opts: defaults,noatime
    state: mounted
