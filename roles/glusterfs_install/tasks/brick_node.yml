- name: Check if the GlusterFS brick directory exists
  ansible.builtin.stat:
    path: /mnt/glusterfs-brick
  register: brick_dir_check

- name: Create GlusterFS brick directory on the brick node
  ansible.builtin.file:
    path: /mnt/glusterfs-brick
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: brick_dir_check.stat.exists == false

- name: Detect filesystem type of /dev/sda
  ansible.builtin.command: lsblk -no FSTYPE /dev/sda
  register: sda_fstype
  changed_when: false

- name: Fail if already formatted (unless allow_format = true)
  ansible.builtin.fail:
    msg: "/dev/sda already has a filesystem: {{ sda_fs_check.stdout }} â€” refusing to format!"
  when:
    - sda_fs_check.stdout != ""
    - not allow_format | default(false)

- name: Format the hard drive only if unformatted
  ansible.builtin.command: mkfs.ext4 /dev/sda
  when: sda_fstype.stdout == ""

- name: Mount the hard drive on the brick node
  ansible.builtin.mount:
    path: /mnt/glusterfs-brick
    src: /dev/sda
    fstype: ext4
    state: mounted
