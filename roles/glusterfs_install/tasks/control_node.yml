---
- name: Determine primary gluster node
  ansible.builtin.set_fact:
    gluster_primary: "{{ groups[gluster_control_group][0] }}"
  run_once: true

- name: Peer probe all brick nodes
  ansible.builtin.command: "gluster peer probe {{ item }}"
  when:
    - inventory_hostname == groups[gluster_bricks_group][0]
    - item != inventory_hostname
  loop: "{{ groups[gluster_bricks_group] }}"
  register: gluster_probe
  failed_when: >
    gluster_probe.rc not in [0] and
    ('already in peer list' not in (gluster_probe.stderr | default('')))
  changed_when: "'already in peer list' not in (gluster_probe.stderr | default(''))"

- name: Build brick list (host:/path) from bricks group
  ansible.builtin.set_fact:
    gluster_bricks_paths: >-
      {{ groups[gluster_bricks_group] | map('regex_replace', '^(.*)$', '\1:' ~ gluster_brick_path) | list }}
  run_once: true

- name: Check if the GlusterFS volume exists
  ansible.builtin.command: "gluster volume info {{ gluster_volume_name }}"
  register: gluster_volume_check
  changed_when: false
  failed_when: false
  when: inventory_hostname == groups[gluster_bricks_group][0]

- name: Create the GlusterFS volume (single or replicated)
  ansible.builtin.command: >-
    gluster volume create {{ gluster_volume_name }}{%- if groups[gluster_bricks_group] | length > 1 %}
    replica {{ groups[gluster_bricks_group] | length }}{%- endif %}
    {{ gluster_bricks_paths | join(' ') }} force
  register: gluster_create
  when:
    - inventory_hostname == groups[gluster_bricks_group][0]
    - gluster_volume_check.rc != 0
  changed_when: "'already exists' not in (gluster_create.stderr | default(''))"

- name: Check if the volume is started
  ansible.builtin.command: "gluster volume status {{ gluster_volume_name }}"
  register: gluster_volume_status
  changed_when: false
  failed_when: false
  when: inventory_hostname == groups[gluster_bricks_group][0]

- name: Start the GlusterFS volume if it is not started
  ansible.builtin.command: "gluster volume start {{ gluster_volume_name }}"
  register: gluster_start
  when:
    - inventory_hostname == groups[gluster_bricks_group][0]
    - gluster_volume_status.rc != 0
  changed_when: "'already' not in (gluster_start.stderr | default(''))"

- name: Get GlusterFS volume info
  ansible.builtin.command: "gluster volume info {{ gluster_volume_name }}"
  register: gluster_info
  changed_when: false
  when: inventory_hostname == groups[gluster_bricks_group][0]

- name: Show GlusterFS volume info
  ansible.builtin.debug:
    var: gluster_info.stdout_lines
  when: inventory_hostname == groups[gluster_bricks_group][0]
