- name: Check if Traefik is already deployed
  ansible.builtin.command: kubectl get pods -n {{ traefik_namespace }} -l app.kubernetes.io/name=traefik
  register: traefik_check
  ignore_errors: true
  changed_when: false
  failed_when: false

- name: Set flag if Traefik is not deployed
  ansible.builtin.set_fact:
    traefik_needs_install: "{{ traefik_check.stdout_lines | length == 0 }}"

- name: Ensure Traefik namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ traefik_namespace }}"
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
  when: traefik_needs_install

- name: Add Traefik Helm repository
  kubernetes.core.helm_repository:
    name: traefik
    repo_url: https://traefik.github.io/charts
  when: traefik_needs_install

- name: Update local Helm repo cache
  ansible.builtin.command: helm repo update
  change_when: false
  when: traefik_needs_install

- name: Install Traefik via Helm
  kubernetes.core.helm:
    name: "{{ helm_release_traefik }}"
    chart_ref: traefik/traefik
    release_namespace: "{{ traefik_namespace }}"
    create_namespace: true
    values:
      ingressClass:
        enabled: true
        isDefaultClass: true
        name: traefik
    wait: true
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
  when: traefik_needs_install
