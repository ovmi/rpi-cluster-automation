#!/bin/bash

# This script collects the CPU temperature from a Raspberry Pi and writes it to a Prometheus textfile format.
# If vcgencmd is not available, it falls back to reading the temperature from the thermal zone file.
# The temperature is then written to a file in the specified directory in a format that Prometheus can scrape.
# Usage: ./temperature_exporter.sh

# Check if the required directory exists
if [ ! -d "{{ node_exporter_collector }}" ]; then
    echo "Directory {{ node_exporter_collector }} does not exist. Creating it."
    mkdir -p {{ node_exporter_collector }}
fi

# Check if the Prometheus text file format with CPU temperature exists
output_file="{{ node_exporter_collector }}/temperature.prom"
if [ ! -f "$output_file" ]; then
    echo "Prometheus file does not exists. Creating it."
    touch "$output_file"

    # Fix ownership and permissions
    chown {{ node_exporter_user }}:{{ node_exporter_group }} "$output_file"
    chmod 644 "$output"
fi

# Check if the vcgencmd command is available
# If it is, use it to get the CPU temperature
# If not, fall back to reading from the thermal zone file     
if command -v vcgencmd &> /dev/null; then
    temp_raw=$(vcgencmd measure_temp | grep -oP '(?<=temp=)[0-9.]+')
else
    temp_raw=$(cat /sys/class/thermal/thermal_zone0/temp)
    temp_raw=$(echo "scale=1; $temp_raw / 1000" | bc)
fi

output="{{ node_exporter_collector }}/temperature.prom"
echo "# HELP rpi_cpu_temperature_celsius CPU temperature in Celsius" > "$output"
echo "# TYPE rpi_cpu_temperature_celsius gauge" >> "$output"
echo "rpi_cpu_temperature_celsius ${temp_raw}" >> "$output"
