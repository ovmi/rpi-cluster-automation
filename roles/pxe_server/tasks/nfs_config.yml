- name: Ensure per-node NFS mount points
  ansible.builtin.file:
    path: "{{ item.root_mnt }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop: "{{ part_list | rejectattr('node', 'equalto', 'node0') | list }}"

- name: Ensure rootfs partition exists
  ansible.builtin.command: "lsblk -no NAME {{ item.root_dev }}"
  register: check_root
  changed_when: false
  failed_when: check_root.rc != 0
  loop: "{{ part_list }}"
  loop_control:
    label: "{{ part_list | rejectattr('node', 'equalto', 'node0') | list }}"

- name: Mount per-node rootfs under NFS base
  ansible.posix.mount:
    path: "{{ item.root_mnt }}"
    src: "{{ item.root_dev }}"
    fstype: "{{ rootfs_fstype }}"
    opts: "{{ rootfs_opts }}"
    state: mounted
  loop: "{{ part_list | rejectattr('node', 'equalto', 'node0') | list }}"
  loop_control:
    label: "{{ item.node }} -> {{ item.root_mnt }}"

- name: Debug filtered list
  ansible.builtin.debug:
    msg: "Mount for {{ item.node }} -> {{ item.root_mnt }}"
  loop: "{{ part_list | rejectattr('node', 'equalto', 'node0') | list }}"
