- name: Ensure rpi-eeprom tools present
  ansible.builtin.package:
    name: rpi-eeprom
    state: present

- name: Determine effective boot mode
  ansible.builtin.set_fact:
    boot_mode_effective: >-
      {{
        boot_mode_param
        if boot_mode_param != 'auto'
        else boot_mode_map[nodes_list[0]].boot_mode
      }}

- name: Debug boot mode resolution
  ansible.builtin.debug:
    msg: "Boot mode set to {{ boot_mode_effective }} applied to nodes: {{ nodes_list | join(', ') }}"

- name: Export current EEPROM config
  ansible.builtin.command: rpi-eeprom-config --out /tmp/bootconf.txt
  register: eeprom_export
  delegate_to: "{{ hostname_map[item] }}"
  loop: "{{ nodes_list }}"
  changed_when: false

- name: Ensure BOOT_ORDER={{ boot_order }}
  ansible.builtin.lineinfile:
    path: /tmp/bootconf.txt
    regexp: '^BOOT_ORDER='
    line: "BOOT_ORDER={{ boot_order }}"
  delegate_to: "{{ hostname_map[item] }}"
  loop: "{{ nodes_list }}"
  register: boot_order_valid

- name: Apply EEPROM image
  ansible.builtin.command: >
    rpi-eeprom-config --apply /tmp/bootconf.txt
  register: eeprom_apply
  changed_when: "'*** CREATED UPDATE' in (eeprom_apply.stdout | default(''))"
  delegate_to: "{{ hostname_map[item] }}"
  loop: "{{ nodes_list }}"
  failed_when: eeprom_apply.rc != 0
  become: true

# - name: Verify BOOT_ORDER on each node
#   ansible.builtin.command: rpi-eeprom-config
#   register: eeprom_readback
#   delegate_to: "{{ hostname_map[item] }}"
#   loop: "{{ nodes_list }}"
#   changed_when: false
#   become: true

# - name: Assert EEPROM BOOT_ORDER matches expected value
#   ansible.builtin.assert:
#     that:
#       - (eeprom_readback.stdout_lines | select('match', '^BOOT_ORDER=') | first | default('')) == "BOOT_ORDER={{ boot_order }}"
#     fail_msg: >-
#       Host {{ hostname_map[item] }}: EEPROM mismatch — expected {{ boot_order }},
#       got {{ eeprom_readback.stdout_lines | select('match', '^BOOT_ORDER=') | list }}
#     success_msg: "Host {{ hostname_map[node] }} BOOT_ORDER verified as {{ boot_order }}"
#   delegate_to: "{{ hostname_map[item] }}"
#   loop: "{{ nodes_list }}"

- name: Collect nodes requiring reboot
  ansible.builtin.set_fact:
    reboot_nodes_list: >-
      {{ reboot_nodes_list | default([]) +
         [node] if ('*** INSTALL' in (eeprom_apply.stdout | default(''))) else reboot_nodes_list | default([]) }}
  loop: "{{ nodes_list }}"
  loop_control:
    loop_var: node

- name: Reboot nodes with updated EEPROM
  ansible.builtin.shell: sleep 2 && reboot
  async: 1
  poll: 0
  become: true
  delegate_to: "{{ hostname_map[item] }}"
  loop: "{{ reboot_nodes_list | default([]) }}"
  loop_control:
    loop_var: node
  changed_when: true

# - name: Reboot if boot order changed
#   ansible.builtin.reboot:
#     reboot_timeout: 300
#     msg: "Reboot triggered because EEPROM boot order changed"
#   when: boot_order_valid.changed and bootmode_reboot
#   become: true

# - name: Stop running tasks on this host (it’s rebooting)
#   ansible.builtin.meta: end_host
