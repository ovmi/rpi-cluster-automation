- name: Ensure rpi-eeprom tools present
  ansible.builtin.package:
    name: rpi-eeprom
    state: present

- name: Resolve boot sequence from mode
  ansible.builtin.set_fact:
    _seq: "{{ boot_sequences[boot_mode] }}"

- name: Build BOOT_ORDER from sequence
  ansible.builtin.set_fact:
    boot_order: "0x{{ _seq | map('extract', boot_modes) | join('') }}"

- name: Export current EEPROM config
  ansible.builtin.command: rpi-eeprom-config --out /tmp/bootconf.txt
  register: eeprom_config
  changed_when: false

- name: Ensure BOOT_ORDER={{ boot_order }}
  ansible.builtin.lineinfile:
    path: /tmp/bootconf.txt
    regexp: '^BOOT_ORDER='
    line: "BOOT_ORDER={{ boot_order }}"
  register: boot_order_valid

- name: Apply EEPROM config when changed
  ansible.builtin.command: rpi-eeprom-config --apply /tmp/bootconf.txt
  when: boot_order_valid.changed
  register: eeprom_apply

- name: Reboot (background, no wait)
  ansible.builtin.shell: "nohup bash -c 'sleep 3; /sbin/reboot' >/dev/null 2>&1 &"
  async: 0
  poll: 0
  when: boot_order_valid.changed and bootmode_reboot
  become: true

- name: Stop running tasks on this host (itâ€™s rebooting)
  ansible.builtin.meta: end_host
