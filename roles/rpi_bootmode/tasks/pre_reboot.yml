- name: Ensure rpi-eeprom tools present
  ansible.builtin.package:
    name: rpi-eeprom
    state: present

- name: Resolve boot sequence from mode
  ansible.builtin.set_fact:
    _seq: "{{ boot_sequences[boot_mode] }}"

- name: Build BOOT_ORDER from sequence
  ansible.builtin.set_fact:
    boot_order: "0x{{ _seq | map('extract', boot_modes) | join('') }}"

- name: Export current EEPROM config
  ansible.builtin.command: rpi-eeprom-config --out /tmp/bootconf.txt
  changed_when: false

- name: Ensure BOOT_ORDER={{ boot_order }}
  ansible.builtin.lineinfile:
    path: /tmp/bootconf.txt
    regexp: '^BOOT_ORDER='
    line: "BOOT_ORDER={{ boot_order }}"
  register: boot_order_valid

- name: Write EEPROM configuration
  ansible.builtin.copy:
    src: bootconf.txt
    dest: /tmp/bootconf.txt
    mode: '0644'
  register: boot_order_valid
  notify: Apply EEPROM config

- name: Reboot if boot order changed
  ansible.builtin.reboot:
    reboot_timeout: 300
    msg: "Reboot triggered because EEPROM boot order changed"
  when: boot_order_valid.changed and bootmode_reboot
  become: true

- name: Stop running tasks on this host (itâ€™s rebooting)
  ansible.builtin.meta: end_host
